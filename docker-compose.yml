version: "3.8"

secrets:
  valkey_pass:
    file: ./secrets/valkey_pass.txt   # plainâ€‘text file containing the password
  weather_api_key:
    file: ./secrets/weather_api_key.txt
  newsdata_api_key:
    file: ./secrets/newsdata_api_key.txt
  finnhub_api_key:
    file: ./secrets/finnhub_api_key.txt

services:
  # Kafka setup
  kafka:
    image: apache/kafka:3.8.0
    container_name: kafka
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      # KRaft mode (no Zookeeper)
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      CLUSTER_ID: 'PYN_mQZxRMC0xTX0hu8_aA'

      # Listeners
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"

      # Basic broker config
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0

      KAFKA_LOG4J_ROOT_LOGLEVEL: WARN
      KAFKA_LOG4J_LOGGERS: 'kafka.cluster.Partition=WARN,kafka.log.UnifiedLog=WARN,kafka.coordinator.group=WARN'
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_NUM_PARTITIONS: 3

    volumes:
      - kafka-data:/var/lib/kafka/data

  # Kafka UI for debugging
  # kafka-ui:
  #   image: provectuslabs/kafka-ui:latest
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     KAFKA_CLUSTERS_0_NAME: local
  #     KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: 192.168.1.102:9092
  #   depends_on:
  #     - kafka

  # Valkey 7.2.8 service
  valkey:
    image: valkey/valkey:7.2.8
    container_name: valkey
    ports:
      - "6379:6379"
    volumes:
      - valkey-data:/data
    restart: unless-stopped
    secrets:
      - valkey_pass
    command: >
      sh -c "valkey-server
      --requirepass \"$$(cat /run/secrets/valkey_pass)\"
      --appendonly yes
      --appendfilename appendonly.aof
      --appendfsync everysec
      --no-appendfsync-on-rewrite yes
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --notify-keyspace-events Ex
      --lazyfree-lazy-eviction yes
      --lazyfree-lazy-expire yes
      --lazyfree-lazy-server-del yes"

  # -------------------------------------------------
  # Weather Service
  # -------------------------------------------------
  weather-service:
    build:
      context: .
      dockerfile: services/weather-service/Dockerfile
    container_name: weather-service
    depends_on:
      - kafka
      - valkey
    restart: unless-stopped
    environment:
      NODE_ENV: production
      KAFKA_BROKER_ADDRESS: kafka:9092
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      VALKEY_PASSWORD_FILE: /run/secrets/valkey_pass
      WEATHER_API_KEY: /run/secrets/weather_api_key
    secrets:
      - valkey_pass
      - weather_api_key

  # -------------------------------------------------
  # Crypto Service
  # -------------------------------------------------
  crypto-service:
    build:
      context: .
      dockerfile: services/crypto-service/Dockerfile
    container_name: crypto-service
    depends_on:
      - kafka
      - valkey
    restart: unless-stopped
    environment:
      NODE_ENV: production
      KAFKA_BROKER_ADDRESS: kafka:9092
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      VALKEY_PASSWORD_FILE: /run/secrets/valkey_pass
      TICKER_FLUSH_INTERVAL_MS: 2000
    secrets:
      - valkey_pass
    ports:
      - "3001:3001"

  # -------------------------------------------------
  # Stock Service
  # -------------------------------------------------
  stock-service:
    build:
      context: .
      dockerfile: services/stock-service/Dockerfile
    container_name: stock-service
    depends_on:
      - kafka
      - valkey
    restart: unless-stopped
    environment:
      NODE_ENV: production
      KAFKA_BROKER_ADDRESS: kafka:9092
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      VALKEY_PASSWORD_FILE: /run/secrets/valkey_pass
      FINNHUB_API_KEY: /run/secrets/finnhub_api_key
    secrets:
      - valkey_pass
      - finnhub_api_key
    ports:
      - "3002:3002"

  # -------------------------------------------------
  # News Service
  # -------------------------------------------------
  news-service:
    build:
      context: .
      dockerfile: services/news-service/Dockerfile
    container_name: news-service
    depends_on:
      - kafka
      - valkey
    restart: unless-stopped
    environment:
      NODE_ENV: production
      KAFKA_BROKER_ADDRESS: kafka:9092
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      VALKEY_PASSWORD_FILE: /run/secrets/valkey_pass
      NEWSDATA_API_KEY: /run/secrets/newsdata_api_key
    secrets:
      - valkey_pass
      - newsdata_api_key
    ports:
      - "3003:3003"

  # -------------------------------------------------
  # Server / BFF
  # -------------------------------------------------
  server:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: server
    depends_on:
      - kafka
      - valkey
      - weather-service
      - crypto-service
      - stock-service
      - news-service
    restart: unless-stopped
    environment:
      NODE_ENV: production
      KAFKA_BROKER_ADDRESS: kafka:9092
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      VALKEY_PASSWORD_FILE: /run/secrets/valkey_pass
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
      SERVER_PORT: 3000
    secrets:
      - valkey_pass
    ports:
      - "3000:3000"

  # -------------------------------------------------
  # Frontend (React + Vite)
  # -------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: frontend
    depends_on:
      - server
    restart: unless-stopped
    ports:
      - "5173:80"


volumes:
  kafka-data:
  valkey-data:
