version: "3.8"

secrets:
  valkey_pass:
    file: ./valkey_pass.txt   # plainâ€‘text file containing the password

services:
  # Kafka setup
  kafka:
    image: apache/kafka:3.8.0
    container_name: kafka
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      # KRaft mode (no Zookeeper)
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      CLUSTER_ID: 'PYN_mQZxRMC0xTX0hu8_aA'

      # Listeners
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://192.168.1.102:9092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"

      # Basic broker config
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0

    volumes:
      - kafka-data:/var/lib/kafka/data

  # Kafka UI for debugging
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: 192.168.1.102:9092
    depends_on:
      - kafka

  # Valkey 7.2.8 service
  valkey:
    image: valkey/valkey:7.2.8
    container_name: valkey
    ports:
      - "6379:6379"
    volumes:
      - valkey-data:/data
    restart: unless-stopped
    secrets:
      - valkey_pass
    command: >
      sh -c "valkey-server
      --requirepass \"$$(cat /run/secrets/valkey_pass)\"
      --appendonly yes
      --appendfilename appendonly.aof
      --appendfsync everysec
      --no-appendfsync-on-rewrite yes
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --notify-keyspace-events Ex
      --lazyfree-lazy-eviction yes
      --lazyfree-lazy-expire yes
      --lazyfree-lazy-server-del yes"

  # -------------------------------------------------
  # Weather Service
  # -------------------------------------------------
  weather-service:
    build:
      context: .
      dockerfile: services/weather-service/Dockerfile
    container_name: weather-service
    env_file:
      - services/weather-service/.env
    depends_on:
      - kafka
      - valkey
    restart: unless-stopped
    environment:
      NODE_ENV: production
      KAFKA_BROKER: kafka:9092
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      VALKEY_PASSWORD_FILE: /run/secrets/valkey_pass
    secrets:
      - valkey_pass

  # -------------------------------------------------
  # Crypto Service
  # -------------------------------------------------
  crypto-service:
    build:
      context: .
      dockerfile: services/crypto-service/Dockerfile
    container_name: crypto-service
    env_file:
      - services/crypto-service/.env
    depends_on:
      - kafka
      - valkey
    restart: unless-stopped
    environment:
      NODE_ENV: production
      KAFKA_BROKER: kafka:9092
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      VALKEY_PASSWORD_FILE: /run/secrets/valkey_pass
    secrets:
      - valkey_pass
    ports:
      - "3001:3001"

  # -------------------------------------------------
  # Stock Service
  # -------------------------------------------------
  stock-service:
    build:
      context: .
      dockerfile: services/stock-service/Dockerfile
    container_name: stock-service
    env_file:
      - services/stock-service/.env
    depends_on:
      - kafka
      - valkey
    restart: unless-stopped
    environment:
      NODE_ENV: production
      KAFKA_BROKER: kafka:9092
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      VALKEY_PASSWORD_FILE: /run/secrets/valkey_pass
    secrets:
      - valkey_pass
    ports:
      - "3002:3002"

  # -------------------------------------------------
  # News Service
  # -------------------------------------------------
  news-service:
    build:
      context: .
      dockerfile: services/news-service/Dockerfile
    container_name: news-service
    env_file:
      - services/news-service/.env
    depends_on:
      - kafka
      - valkey
    restart: unless-stopped
    environment:
      NODE_ENV: production
      KAFKA_BROKER: kafka:9092
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      VALKEY_PASSWORD_FILE: /run/secrets/valkey_pass
    secrets:
      - valkey_pass
    ports:
      - "3003:3003"


volumes:
  kafka-data:
  valkey-data:
